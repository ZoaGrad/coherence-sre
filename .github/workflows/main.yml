name: Coherence CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  quality:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ".[dev,connectors,dashboard]"
        
    - name: Static Analysis (Ruff)
      # We run ruff but don't fail the build yet if it's strictly stylistic
      # For Phase 2.5, let's just check for syntax errors or major issues
      run: |
        ruff check src tests --select E9,F63,F7,F82 --target-version py311

    - name: Type Checking (Mypy)
      run: |
        mypy src/coherence

    - name: Run Tests (Pytest)
      run: |
        pytest tests/

  build-container:
    name: Verify Docker Build
    runs-on: ubuntu-latest
    needs: quality
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker Image
      run: docker build . --file Dockerfile --tag coherence-sre:ci
      
    - name: Verify Run (Simulation)
      # We run the container for 5 seconds to ensure it boots, then kill it
      run: timeout 5s docker run --rm coherence-sre:ci --source sim || code=$?; if [[ $code -ne 124 && $code -ne 0 ]]; then exit $code; fi
